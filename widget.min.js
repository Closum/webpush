var closumRef="https://app.closum.com";var closumObj=window.clo;if(!Object.prototype.watch){Object.defineProperty(Object.prototype,"watch",{enumerable:!1,configurable:!0,writable:!0,value:function(prop,handler){var
oldval=this[prop],newval=oldval,getter=function(){return newval},setter=function(val){oldval=newval;return newval=handler.call(this,prop,oldval,val)};if(delete this[prop]){Object.defineProperty(this,prop,{get:getter,set:setter,enumerable:!0,configurable:!0})}}})}(function(){if(closumObj.calls){for(let index=0;index<closumObj.calls.length;index++){var key=closumObj.calls[index].type;switch(key){case "cPopup":cPopup(closumObj.calls[index]);break;case "lpPopup":lpPopup(closumObj.calls[index]);break;case "embForm":embForm(closumObj.calls[index]);break;case "webpushPopup":webpushPopup(closumObj.calls[index]);break;default:}}}else{Object.keys(closumObj).forEach(function(key,index){switch(key){case "cPopup":cPopup(closumObj[key]);break;case "lpPopup":lpPopup(closumObj[key]);break;case "embForm":embForm(closumObj[key]);break;case "webpushPopup":webpushPopup(closumObj[key]);break;default:}})}
scriptStyles()})();function scriptStyles(){var head=document.getElementsByTagName('head')[0];var style=document.createElement('link');style.href=closumRef+'/tools/form-widget/widget.min.css';style.type='text/css';style.rel='stylesheet';head.append(style)}
function setLocalStorageWithExpiry(key,expirationInHours){const now=new Date();const expirationTime=now.getTime()+expirationInHours*60*60*1000;const data={expiresAt:expirationTime};localStorage.setItem(key,JSON.stringify(data))}
function getLocalStorageWithExpiry(key){const item=localStorage.getItem(key);if(!item){return null}
const data=JSON.parse(item);const now=new Date();if(now.getTime()>data.expiresAt){localStorage.removeItem(key);return null}
return data.expiresAt}
closumObj.watch("cPopup",cPopup);function cPopup(v){if(v.id){var style=v.size;var v=v.id}
var elem=document.createElement('iframe');elem.className='closum-popwidget';elem.id="closum-c-popup"+v;elem.name="closum-c-popup";elem.dataset.cid=v;document.body.appendChild(elem);var url=closumRef+"/web/api/popup/get/"+v;getJSON(url,!1,function(response){if(response.status==0){document.getElementById("closum-c-popup"+v).remove();return}
document.querySelector("#closum-c-popup"+v).style.display="none";if(response.response.popup_data.only_event==1){var item=localStorage.getItem("hadModal");if(item){var retrievedData=getLocalStorageWithExpiry("hadModal");if(retrievedData!=null){return}}else{var myKey="hadModal";var expirationHours=24;setLocalStorageWithExpiry(myKey,expirationHours)}}
if(response.response.popup_data.popup_type_id==2){var wael=document.createElement('img');wael.id="cwa-button";wael.width='70';wael.height='70';wael.src="https://app.closum.com/img/popups/whatsappicon.png";document.body.appendChild(wael);document.querySelector("#cwa-button").addEventListener("click",function(e){document.querySelector("#closum-c-popup"+v).style.display=document.querySelector("#closum-c-popup"+v).style.display==='flex'?'none':'flex'})}
setTimeout(function(){document.getElementById('closum-c-popup'+v).setAttribute("src",closumRef+"/web/popup/view/"+v);if(response.response.popup_data.popup_type_id==1){document.querySelector("#closum-c-popup"+v).style.display=document.querySelector("#closum-c-popup"+v).style.display==='flex'?'none':'flex'}},response.response.popup_data.delay);var eventMethod=window.addEventListener?"addEventListener":"attachEvent";var eventer=window[eventMethod];var messageEvent=eventMethod==="attachEvent"?"onmessage":"message";eventer(messageEvent,function(e){if(e.origin!==closumRef)return;if((e.data==="close-popup"||e.message==="close-popup")&&response.response.popup_data.popup_type_id==1){document.querySelector("iframe#closum-c-popup"+v).remove()}else if((e.data==="close-popup"||e.message==="close-popup")&&response.response.popup_data.popup_type_id==2){document.querySelector("#closum-c-popup"+v).style.display=document.querySelector("#closum-c-popup"+v).style.display='none'}
if(e.data==="waredirect"){window.open('https://api.whatsapp.com/send/?phone='+response.response.popup_data.wa_contact+'&text='+response.response.popup_data.wa_message+'&type=phone_number&app_absent=0','_blank').focus();document.querySelector("#closum-c-popup"+v).style.display=document.querySelector("#closum-c-popup"+v).style.display==='flex'?'none':'flex'}})})};closumObj.watch("lpPopup",lpPopup);function lpPopup(v){var elem=document.createElement('div');elem.className='closum-widget';elem.id="closum-c-popup";elem.dataset.cid=v;document.body.appendChild(elem);appendToWidget("#closum-c-popup","div","",'<div class="clo-widget-container"><button class="closum-close-btn" id="closum-close-btn"></button><div class="clo-widget-item clo-widget-image"></div><div class="clo-widget-item clo-widget-campaign-details"></div></div><div class="clo-widget-container"><a href="#" class="clo-widget-btn"></a></div>');var url=closumRef+"/api/landing-page/view/"+v;getJSON(url,!1,function(response){if(!response.company.addon_hide_lp_signature){appendToWidget("#closum-c-popup","div","",'<div class="clo-widget-container clo-widget-footer"><a href="https://www.closum.com/?utm_source=cpopup" target="_blank">by <strong>Closum</strong></a></div>')}
appendToWidget("#closum-c-popup"+" .clo-widget-campaign-details","div","title",response.page_title);if(response.landing_page_configuration!=undefined&&response.landing_page_configuration.fb_share_image!=undefined){appendToWidget("#closum-c-popup"+" .clo-widget-image","span","",'<img src="'+response.landing_page_configuration.fb_share_image+'">')}
document.querySelectorAll('a.clo-widget-btn')[0].href=response.link;appendToWidget("#closum-c-popup"+" .clo-widget-btn","div","clo-widget-item",response.button_copy)});document.getElementById("closum-close-btn").addEventListener("click",function(){var elem=document.getElementById("closum-c-popup");elem.parentNode.removeChild(elem)})};closumObj.watch("embForm",embForm);function embForm(v){if(v.id){var style=v.size;var v=v.id}
var url=closumRef+"/web/forms/view/"+v;var elem=document.createElement('iframe');elem.className='closum-embform';elem.id="closum-e-form"+v;elem.dataset.cid=v;elem.src=url;if(style){elem.style.height=style}
if(document.getElementById("form-"+v)){document.getElementById("form-"+v).appendChild(elem)}else{elem.style.position="fixed";elem.style.top="50%";elem.style.left="50%";elem.style.width="70%";elem.style.height="400px";elem.style.transform="translate(-50%, -50%)";elem.style.zIndex="100";var divOpacity=document.createElement("div");divOpacity.style.zIndex="99";divOpacity.style.width="100%";divOpacity.style.height="100%";divOpacity.style.opacity="0.5";divOpacity.style.background="grey";divOpacity.style.position="fixed";divOpacity.style.top="0";divOpacity.onclick=function(){divOpacity.remove();elem.remove()};document.body.appendChild(divOpacity);document.body.appendChild(elem)}}
function appendToWidget(parentSelector,tag,classes,html){var parentNode=document.querySelector(parentSelector);var childNode=document.createElement(tag);childNode.innerHTML=html;childNode.className+=classes;parentNode.appendChild(childNode)}
function getJSON(url,inHtml,callback){var request=new XMLHttpRequest();request.open('GET',url,!0);request.onload=function(){if(request.status===200){if(inHtml){var data=request.responseText}else{var data=JSON.parse(request.responseText)}
callback(data)}};request.setRequestHeader("Accept","application/json");request.send()}
closumObj.watch("webpushPopup",webpushPopup);function webpushPopup(v){if(Notification.permission!=="granted"){console.log("Notification permission not granted.");handleNoSubscription(v);return}
navigator.serviceWorker.ready.then((registration)=>registration.pushManager.getSubscription()).then((subscription)=>{if(!subscription){console.log("No push subscription found.");handleNoSubscription(v);return}
console.log("Existing subscription");return}).catch((e)=>{console.error("Error checking subscription",e);handleNoSubscription(v)})}
function handleNoSubscription(v){console.log("handleNoSubscription");if(v.id){var style=v.size;var v=v.id}
var elem=document.createElement("iframe");elem.className="closum-popwidget";elem.id="closum-webpush-popup"+v;elem.name="closum-webpush-popup";elem.dataset.cid=v;document.body.appendChild(elem);var url=closumRef+"/web/api/popup/get/"+v;getJSON(url,!1,function(response){if(response.status==0){document.getElementById("closum-webpush-popup"+v).remove();return}
document.querySelector("#closum-webpush-popup"+v).style.display="none";setTimeout(function(){document.getElementById("closum-webpush-popup"+v).setAttribute("src",closumRef+"/web/popup/view_webpush/"+v);if(response.response.popup_data.popup_type_id==4){document.querySelector("#closum-webpush-popup"+v).style.display=document.querySelector("#closum-webpush-popup"+v).style.display==="flex"?"none":"flex"}},response.response.popup_data.delay);var eventMethod=window.addEventListener?"addEventListener":"attachEvent";var eventer=window[eventMethod];var messageEvent=eventMethod==="attachEvent"?"onmessage":"message";eventer(messageEvent,function(e){if(e.origin!==closumRef)return;if(e.data.type==="popup"){console.log(e.data);localStorage.setItem("closum-Email",e.data.email);localStorage.setItem("closum-Popup",e.data.popup);localStorage.setItem("closum-Company",e.data.company);callWebPush()}
if((e.data==="close-popup"||e.message==="close-popup")&&response.response.popup_data.popup_type_id==4){document.querySelector("iframe#closum-webpush-popup"+v).remove()}})})}
function callWebPush(){var email=localStorage.getItem("closum-Email");if(email){console.log("callWebPush with email: "+email);navigator.serviceWorker.register("/serviceWorker.js").then(()=>{console.log("[SW] Service worker has been registered");push_subscribe()},(e)=>{console.error("[SW] Service worker registration failed",e)})}}
function push_subscribe(){const applicationServerKey="BKdg3MiAFgrxL-MbRZQMWuELs3s8tlhQdBnTk5Sveg4nnXTReJEd4I1X0OPcdkQck5SVLmF4u4AdUGiPGnIGR0U";return checkNotificationPermission().then(()=>navigator.serviceWorker.ready).then((serviceWorkerRegistration)=>serviceWorkerRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:urlBase64ToUint8Array(applicationServerKey),})).then((subscription)=>{return push_sendSubscriptionToServer(subscription,"POST")}).then((subscription)=>subscription).catch((e)=>{if(Notification.permission==="denied"){console.warn("Notifications are denied by the user.")}else{console.error("Impossible to subscribe to push notifications",e)}})}
function checkNotificationPermission(){return new Promise((resolve,reject)=>{if(Notification.permission==="denied"){return reject(new Error("Push messages are blocked."))}
if(Notification.permission==="granted"){return resolve()}
if(Notification.permission==="default"){return Notification.requestPermission().then((result)=>{if(result!=="granted"){reject(new Error("Bad permission result"))}else{resolve()}})}
return reject(new Error("Unknown permission"))})}
function urlBase64ToUint8Array(base64String){const padding="=".repeat((4-(base64String.length%4))%4);const base64=(base64String+padding).replace(/\-/g,"+").replace(/_/g,"/");const rawData=window.atob(base64);const outputArray=new Uint8Array(rawData.length);for(let i=0;i<rawData.length;++i){outputArray[i]=rawData.charCodeAt(i)}
return outputArray}
function push_sendSubscriptionToServer(subscription,method){var email=localStorage.getItem("closum-Email");var company=localStorage.getItem("closum-Company");var popup=localStorage.getItem("closum-Popup");const key=subscription.getKey("p256dh");const token=subscription.getKey("auth");const contentEncoding=(PushManager.supportedContentEncodings||["aesgcm",])[0];return fetch("https://app.closum.com/api/web-push/push",{method,body:JSON.stringify({email:email,company_id:company,popup_id:popup,endpoint:subscription.endpoint,publicKey:key?btoa(String.fromCharCode.apply(null,new Uint8Array(key))):null,authToken:token?btoa(String.fromCharCode.apply(null,new Uint8Array(token))):null,contentEncoding,}),}).then(()=>subscription)}
